"""
MAIN.PY - –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø –¥–ª—è Render —Å–æ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º —Ñ–æ—Ç–æ
"""

import os
import logging
import asyncio
from datetime import datetime

from aiogram import Bot, Dispatcher, types, F
from aiogram.types import Message, ReplyKeyboardRemove
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.enums import ParseMode
from aiogram.client.default import DefaultBotProperties

import config
from states import UserState, AdminState
import keyboards
import photo_map
from user_storage import (
    save_user_data, get_user_data_value, add_selected_problem,
    remove_selected_problem, get_selected_problems,
    clear_selected_problems, delete_user_data
)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
bot = Bot(token=config.BOT_TOKEN, default=DefaultBotProperties(parse_mode=ParseMode.HTML))
storage = MemoryStorage()
dp = Dispatcher(storage=storage)

# ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================

async def send_recommended_photos(chat_id: int, photo_keys: list, caption: str = ""):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ –∏–∑ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞"""
    try:
        if not photo_keys:
            await bot.send_message(
                chat_id, 
                "üì∑ –§–æ—Ç–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è —ç—Ç–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.\n\n"
                "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∫–æ—Ä–æ –¥–æ–±–∞–≤–∏—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏!",
                reply_markup=keyboards.selection_complete_keyboard()
            )
            return

        sent_count = 0
        for photo_key in photo_keys:
            file_id = photo_map.get_photo_file_id(photo_key)
            if file_id:
                # –ù–∞—Ö–æ–¥–∏–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è
                display_name = photo_key
                for category in config.PHOTO_STRUCTURE.values():
                    for subcat_products in category.values():
                        for key, name in subcat_products:
                            if key == photo_key:
                                display_name = name
                                break

                await bot.send_photo(
                    chat_id=chat_id,
                    photo=file_id,
                    caption=f"{caption}\n<b>{display_name}</b>" if caption else f"<b>{display_name}</b>",
                    parse_mode=ParseMode.HTML
                )
                sent_count += 1
                await asyncio.sleep(0.5)  # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Ñ–æ—Ç–æ

        if sent_count == 0:
            await bot.send_message(
                chat_id,
                "üì∑ –§–æ—Ç–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.\n\n"
                "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–ª—è —ç—Ç–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤.",
                reply_markup=keyboards.selection_complete_keyboard()
            )

    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ç–æ: {e}")
        await bot.send_message(
            chat_id,
            "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ç–æ.",
            reply_markup=keyboards.selection_complete_keyboard()
        )

async def get_body_recommendations_with_photos(goal: str) -> tuple:
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –¥–ª—è —Ç–µ–ª–∞ —Å —Ñ–æ—Ç–æ"""
    try:
        if goal in config.BODY_DATA:
            data = config.BODY_DATA[goal]
            text = f"{data['title']}\n\n"
            for product in data['products']:
                text += f"‚Ä¢ {product}\n"
            if 'note' in data:
                text += f"\n{data['note']}"
        else:
            text = config.get_body_recommendations_html(goal)

        photo_keys = config.PHOTO_MAPPING.get("—Ç–µ–ª–æ", {}).get(goal, [])
        return text, photo_keys

    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –¥–ª—è —Ç–µ–ª–∞: {e}")
        return "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.", []

async def get_hair_recommendations_with_photos(hair_type: str, problems: list, 
                                              scalp_type: str, hair_volume: str, 
                                              hair_color: str = "") -> tuple:
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –¥–ª—è –≤–æ–ª–æ—Å —Å —Ñ–æ—Ç–æ"""
    try:
        text = config.get_hair_recommendations_html(hair_type, problems, scalp_type, hair_volume, hair_color)
        photo_keys = []

        # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ –ø–æ —Ç–∏–ø—É –≤–æ–ª–æ—Å
        if hair_type in config.PHOTO_MAPPING.get("–≤–æ–ª–æ—Å—ã", {}):
            photo_keys.extend(config.PHOTO_MAPPING["–≤–æ–ª–æ—Å—ã"][hair_type])

        # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ –ø–æ –ø—Ä–æ–±–ª–µ–º–∞–º
        for problem in problems:
            if problem in config.PHOTO_MAPPING.get("–≤–æ–ª–æ—Å—ã", {}):
                photo_keys.extend(config.PHOTO_MAPPING["–≤–æ–ª–æ—Å—ã"][problem])

        # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ –¥–ª—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–π –∫–æ–∂–∏
        if scalp_type == "–î–∞, —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞—è":
            sensitive_keys = config.PHOTO_MAPPING["–≤–æ–ª–æ—Å—ã"].get("—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞—è_–∫–æ–∂–∞", [])
            photo_keys.extend(sensitive_keys)

        # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ –¥–ª—è –æ–±—ä–µ–º–∞
        if hair_volume == "–î–∞, —Ö–æ—á—É –æ–±—ä–µ–º":
            volume_keys = config.PHOTO_MAPPING["–≤–æ–ª–æ—Å—ã"].get("–æ–±—ä–µ–º", [])
            photo_keys.extend(volume_keys)

        # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ –ø–æ —Ü–≤–µ—Ç—É –≤–æ–ª–æ—Å
        if hair_color in ["–®–∞—Ç–µ–Ω–∫–∞", "–†—É—Å–∞—è"]:
            chocolate_keys = config.PHOTO_MAPPING["–≤–æ–ª–æ—Å—ã"].get("–æ—Ç—Ç–µ–Ω–µ—á–Ω–∞—è_—à–æ–∫–æ–ª–∞–¥", [])
            photo_keys.extend(chocolate_keys)
        elif hair_color == "–†—ã–∂–∞—è":
            copper_keys = config.PHOTO_MAPPING["–≤–æ–ª–æ—Å—ã"].get("–æ—Ç—Ç–µ–Ω–µ—á–Ω–∞—è_–º–µ–¥–Ω—ã–π", [])
            photo_keys.extend(copper_keys)

        # –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
        photo_keys = list(set(photo_keys))
        return text, photo_keys

    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –¥–ª—è –≤–æ–ª–æ—Å: {e}")
        return "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.", []

# ==================== –ö–û–ú–ê–ù–î–´ –ë–û–¢–ê ====================

@dp.message(Command("start"))
async def cmd_start(message: Message, state: FSMContext):
    try:
        await state.clear()
        delete_user_data(message.from_user.id)

        welcome_text = (
            "üëã <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ SVOY AV.COSMETIC!</b>\n\n"
            "–Ø –ø–æ–º–æ–≥—É –ø–æ–¥–æ–±—Ä–∞—Ç—å –∏–¥–µ–∞–ª—å–Ω—É—é –∫–æ—Å–º–µ—Ç–∏–∫—É –¥–ª—è:\n"
            "üíá‚Äç‚ôÄÔ∏è <b>–í–æ–ª–æ—Å</b> ‚Äî –ø–æ–¥–±–æ—Ä –ø–æ —Ç–∏–ø—É, –ø—Ä–æ–±–ª–µ–º–∞–º –∏ —Ü–≤–µ—Ç—É\n"
            "üß¥ <b>–¢–µ–ª–æ</b> ‚Äî —É—Ö–æ–¥ –ø–æ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—è–º –∫–æ–∂–∏\n\n"
            "<i>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:</i>"
        )

        await message.answer(
            welcome_text,
            reply_markup=keyboards.main_menu_keyboard()
        )
        await state.set_state(UserState.CHOOSING_CATEGORY)
        logger.info(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.from_user.id} –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞")

    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ cmd_start: {e}")
        await message.answer(
            "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
            reply_markup=keyboards.main_menu_keyboard()
        )

@dp.message(Command("help"))
async def cmd_help(message: Message):
    help_text = (
        "üìö <b>–°–ø—Ä–∞–≤–∫–∞ –ø–æ –±–æ—Ç—É</b>\n\n"
        "<b>–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:</b>\n"
        "üíá‚Äç‚ôÄÔ∏è <b>–í–æ–ª–æ—Å—ã</b> ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥–±–æ—Ä –∫–æ—Å–º–µ—Ç–∏–∫–∏\n"
        "üß¥ <b>–¢–µ–ª–æ</b> ‚Äî —É—Ö–æ–¥ –ø–æ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—è–º –∫–æ–∂–∏\n\n"
        "<b>–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–¥–±–æ—Ä:</b>\n"
        "1. –í—ã–±–∏—Ä–∞–µ—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é (–≤–æ–ª–æ—Å—ã/—Ç–µ–ª–æ)\n"
        "2. –û—Ç–≤–µ—á–∞–µ—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Ç–∏–ø–µ/–ø—Ä–æ–±–ª–µ–º–∞—Ö\n"
        "3. –ü–æ–ª—É—á–∞–µ—Ç–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ —Ñ–æ—Ç–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤\n\n"
        "<b>–ù–∞–≤–∏–≥–∞—Ü–∏—è:</b>\n"
        "‚Ü©Ô∏è <b>–ù–∞–∑–∞–¥</b> ‚Äî –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π —à–∞–≥\n"
        "üè† <b>–í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</b> ‚Äî –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –Ω–∞—á–∞–ª–æ"
    )

    await message.answer(
        help_text,
        reply_markup=keyboards.main_menu_keyboard()
    )

@dp.message(Command("status"))
async def cmd_status(message: Message):
    try:
        all_photos = photo_map.get_all_photos()
        photo_count = len(all_photos)
        
        hair_count = 0
        body_count = 0
        
        for key, file_id in all_photos.items():
            if file_id:  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
                if key in config.PHOTO_STRUCTURE.get("–≤–æ–ª–æ—Å—ã", {}):
                    hair_count += 1
                elif key in config.PHOTO_STRUCTURE.get("—Ç–µ–ª–æ", {}):
                    body_count += 1

        status_text = (
            "üìä <b>–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</b>\n\n"
            f"ü§ñ <b>–ë–æ—Ç:</b> –ê–∫—Ç–∏–≤–µ–Ω ‚úÖ\n\n"
            f"üìà <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ñ–æ—Ç–æ:</b>\n"
            f"‚Ä¢ –í—Å–µ–≥–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: {photo_count}\n"
            f"‚Ä¢ –í–æ–ª–æ—Å—ã: {hair_count}\n"
            f"‚Ä¢ –¢–µ–ª–æ: {body_count}\n\n"
            f"üïê <b>–í—Ä–µ–º—è:</b> {datetime.now().strftime('%H:%M:%S')}"
        )

        await message.answer(
            status_text,
            reply_markup=keyboards.main_menu_keyboard()
        )

    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ cmd_status: {e}")
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞")

@dp.message(Command("admin"))
async def cmd_admin(message: Message, state: FSMContext):
    if message.from_user.id not in config.ADMIN_IDS:
        await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.")
        return
        
    await state.set_state(AdminState.WAITING_PASSWORD)
    await message.answer(
        "üîê <b>–î–æ—Å—Ç—É–ø –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏</b>\n\n–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞:",
        reply_markup=keyboards.back_to_menu_keyboard()
    )

# ==================== –ù–ê–í–ò–ì–ê–¶–ò–û–ù–ù–´–ï –ö–ù–û–ü–ö–ò ====================

@dp.message(F.text == "‚ùì –ü–æ–º–æ—â—å")
async def process_help(message: Message):
    await cmd_help(message)

@dp.message(F.text == "üè† –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")
async def process_main_menu(message: Message, state: FSMContext):
    await state.clear()
    clear_selected_problems(message.from_user.id)

    welcome_text = "üëã <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ SVOY AV.COSMETIC!</b>\n\n<i>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:</i>"
    await message.answer(
        welcome_text,
        reply_markup=keyboards.main_menu_keyboard()
    )
    await state.set_state(UserState.CHOOSING_CATEGORY)

@dp.message(F.text == "‚Ü©Ô∏è –ù–∞–∑–∞–¥")
async def process_back(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–ù–∞–∑–∞–¥' - –ª–æ–≥–∏—á–µ—Å–∫–∏–π –≤–æ–∑–≤—Ä–∞—Ç –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π —à–∞–≥"""
    current_state = await state.get_state()
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω–∞ –∫–∞–∫–æ–π —à–∞–≥ –≤–µ—Ä–Ω—É—Ç—å—Å—è
    if current_state == UserState.HAIR_CHOOSING_COLOR:
        await state.set_state(UserState.HAIR_CHOOSING_VOLUME)
        await message.answer(
            "<i>–•–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–º –≤–æ–ª–æ—Å–∞–º?</i>",
            reply_markup=keyboards.hair_volume_keyboard()
        )
    elif current_state == UserState.HAIR_CHOOSING_VOLUME:
        await state.set_state(UserState.HAIR_CHOOSING_SCALP)
        await message.answer(
            "<i>–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞—è –∫–æ–∂–∞ –≥–æ–ª–æ–≤—ã?</i>",
            reply_markup=keyboards.scalp_type_keyboard()
        )
    elif current_state == UserState.HAIR_CHOOSING_SCALP:
        await state.set_state(UserState.HAIR_CHOOSING_PROBLEMS)
        selected_problems = get_selected_problems(message.from_user.id)
        await message.answer(
            "<i>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—ã –≤–æ–ª–æ—Å (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ):</i>\n"
            "<b>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ø—Ä–æ–±–ª–µ–º—É, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å/–æ—Ç–º–µ–Ω–∏—Ç—å</b>\n\n"
            "<i>–ú–æ–∂–Ω–æ –Ω–∞–∂–∞—Ç—å '‚úÖ –ì–æ—Ç–æ–≤–æ' –±–µ–∑ –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–±–ª–µ–º</i>",
            reply_markup=keyboards.hair_problems_keyboard(selected_problems)
        )
    elif current_state == UserState.HAIR_CHOOSING_PROBLEMS:
        await state.set_state(UserState.HAIR_CHOOSING_TYPE)
        await message.answer(
            "üíá‚Äç‚ôÄÔ∏è <b>–û—Ç–ª–∏—á–Ω–æ! –ü–æ–¥–±–µ—Ä–µ–º —É—Ö–æ–¥ –¥–ª—è –≤–æ–ª–æ—Å.</b>\n\n<i>–ö–∞–∫–æ–π —É –≤–∞—Å —Ç–∏–ø –≤–æ–ª–æ—Å?</i>",
            reply_markup=keyboards.hair_type_keyboard()
        )
    elif current_state == UserState.HAIR_CHOOSING_TYPE:
        await state.set_state(UserState.CHOOSING_CATEGORY)
        await message.answer(
            "üëã <b>–ü–æ–¥–±–µ—Ä–µ–º –∏–¥–µ–∞–ª—å–Ω—É—é –∫–æ—Å–º–µ—Ç–∏–∫—É!</b>\n\n<i>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:</i>",
            reply_markup=keyboards.main_menu_keyboard()
        )
    elif current_state == UserState.BODY_CHOOSING_GOAL:
        await state.set_state(UserState.CHOOSING_CATEGORY)
        await message.answer(
            "üëã <b>–ü–æ–¥–±–µ—Ä–µ–º –∏–¥–µ–∞–ª—å–Ω—É—é –∫–æ—Å–º–µ—Ç–∏–∫—É!</b>\n\n<i>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:</i>",
            reply_markup=keyboards.main_menu_keyboard()
        )
    else:
        await state.set_state(UserState.CHOOSING_CATEGORY)
        await message.answer(
            "üëã <b>–ü–æ–¥–±–µ—Ä–µ–º –∏–¥–µ–∞–ª—å–Ω—É—é –∫–æ—Å–º–µ—Ç–∏–∫—É!</b>\n\n<i>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:</i>",
            reply_markup=keyboards.main_menu_keyboard()
        )

@dp.message(F.text == "üíá‚Äç‚ôÄÔ∏è –ù–æ–≤–∞—è –ø–æ–¥–±–æ—Ä–∫–∞ –≤–æ–ª–æ—Å")
async def process_new_hair_selection(message: Message, state: FSMContext):
    await state.clear()
    clear_selected_problems(message.from_user.id)
    await state.set_state(UserState.HAIR_CHOOSING_TYPE)
    
    await message.answer(
        "üíá‚Äç‚ôÄÔ∏è <b>–û—Ç–ª–∏—á–Ω–æ! –ü–æ–¥–±–µ—Ä–µ–º —É—Ö–æ–¥ –¥–ª—è –≤–æ–ª–æ—Å.</b>\n\n<i>–ö–∞–∫–æ–π —É –≤–∞—Å —Ç–∏–ø –≤–æ–ª–æ—Å?</i>",
        reply_markup=keyboards.hair_type_keyboard()
    )

@dp.message(F.text == "üß¥ –ù–æ–≤–∞—è –ø–æ–¥–±–æ—Ä–∫–∞ —Ç–µ–ª–∞")
async def process_new_body_selection(message: Message, state: FSMContext):
    await state.clear()
    await state.set_state(UserState.BODY_CHOOSING_GOAL)
    
    await message.answer(
        "üß¥ <b>–ü—Ä–µ–∫—Ä–∞—Å–Ω–æ! –ó–∞–π–º–µ–º—Å—è —É—Ö–æ–¥–æ–º –∑–∞ —Ç–µ–ª–æ–º.</b>\n\n<i>–ö–∞–∫–æ–≤–∞ –≤–∞—à–∞ –æ—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å —É—Ö–æ–¥–∞?</i>",
        reply_markup=keyboards.body_goals_keyboard()
    )

# ==================== –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ –ò –í–´–ë–û–† –ö–ê–¢–ï–ì–û–†–ò–ò ====================

@dp.message(UserState.CHOOSING_CATEGORY, F.text == "üíá‚Äç‚ôÄÔ∏è –í–æ–ª–æ—Å—ã")
async def process_hair_category(message: Message, state: FSMContext):
    clear_selected_problems(message.from_user.id)
    await state.set_state(UserState.HAIR_CHOOSING_TYPE)
    await message.answer(
        "üíá‚Äç‚ôÄÔ∏è <b>–û—Ç–ª–∏—á–Ω–æ! –ü–æ–¥–±–µ—Ä–µ–º —É—Ö–æ–¥ –¥–ª—è –≤–æ–ª–æ—Å.</b>\n\n<i>–ö–∞–∫–æ–π —É –≤–∞—Å —Ç–∏–ø –≤–æ–ª–æ—Å?</i>",
        reply_markup=keyboards.hair_type_keyboard()
    )

@dp.message(UserState.CHOOSING_CATEGORY, F.text == "üß¥ –¢–µ–ª–æ")
async def process_body_category(message: Message, state: FSMContext):
    await state.set_state(UserState.BODY_CHOOSING_GOAL)
    await message.answer(
        "üß¥ <b>–ü—Ä–µ–∫—Ä–∞—Å–Ω–æ! –ó–∞–π–º–µ–º—Å—è —É—Ö–æ–¥–æ–º –∑–∞ —Ç–µ–ª–æ–º.</b>\n\n<i>–ö–∞–∫–æ–≤–∞ –≤–∞—à–∞ –æ—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å —É—Ö–æ–¥–∞?</i>",
        reply_markup=keyboards.body_goals_keyboard()
    )

# ==================== –û–ü–†–û–° –î–õ–Ø –¢–ï–õ–ê ====================

@dp.message(UserState.BODY_CHOOSING_GOAL, F.text.in_(config.BODY_GOALS))
async def process_body_goal(message: Message, state: FSMContext):
    try:
        goal = message.text
        save_user_data(message.from_user.id, "body_goal", goal)

        recommendations, photo_keys = await get_body_recommendations_with_photos(goal)

        await message.answer(
            recommendations,
            reply_markup=keyboards.selection_complete_keyboard()
        )

        if photo_keys:
            await send_recommended_photos(
                message.chat.id,
                photo_keys,
                "üõçÔ∏è <b>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã:</b>"
            )
        else:
            await message.answer(
                "üì∑ –§–æ—Ç–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.",
                reply_markup=keyboards.selection_complete_keyboard()
            )

        await message.answer(
            config.SALES_POINTS + "\n\n" + config.DELIVERY_INFO,
            reply_markup=keyboards.selection_complete_keyboard()
        )

        await state.clear()
        logger.info(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.from_user.id} –ø–æ–ª—É—á–∏–ª —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Ç–µ–ª–∞: {goal}")

    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ process_body_goal: {e}")
        await message.answer(
            "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
            reply_markup=keyboards.selection_complete_keyboard()
        )
        await state.clear()

# ==================== –û–ü–†–û–° –î–õ–Ø –í–û–õ–û–° ====================

@dp.message(UserState.HAIR_CHOOSING_TYPE, F.text.in_(config.HAIR_TYPES))
async def process_hair_type(message: Message, state: FSMContext):
    hair_type = message.text
    save_user_data(message.from_user.id, "hair_type", hair_type)

    await state.set_state(UserState.HAIR_CHOOSING_PROBLEMS)
    await message.answer(
        f"‚úÖ <b>{hair_type}</b>\n\n"
        "<i>–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—ã –≤–æ–ª–æ—Å (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ):</i>\n"
        "<b>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ø—Ä–æ–±–ª–µ–º—É, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å/–æ—Ç–º–µ–Ω–∏—Ç—å</b>\n\n"
        "<i>–ú–æ–∂–Ω–æ –Ω–∞–∂–∞—Ç—å '‚úÖ –ì–æ—Ç–æ–≤–æ' –±–µ–∑ –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–±–ª–µ–º</i>",
        reply_markup=keyboards.hair_problems_keyboard([])
    )

@dp.message(UserState.HAIR_CHOOSING_PROBLEMS)
async def process_hair_problems(message: Message, state: FSMContext):
    if message.text == "‚úÖ –ì–æ—Ç–æ–≤–æ":
        selected_problems = get_selected_problems(message.from_user.id)
        logger.info(f"–í—ã–±—Ä–∞–Ω–æ –ø—Ä–æ–±–ª–µ–º: {selected_problems}")

        await state.set_state(UserState.HAIR_CHOOSING_SCALP)
        await message.answer(
            "<i>–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞—è –∫–æ–∂–∞ –≥–æ–ª–æ–≤—ã?</i>",
            reply_markup=keyboards.scalp_type_keyboard()
        )

    elif message.text.startswith("‚òê ") or message.text.startswith("‚úÖ "):
        problem = message.text.replace("‚úÖ ", "").replace("‚òê ", "")

        if problem not in config.HAIR_PROBLEMS:
            return

        current_problems = get_selected_problems(message.from_user.id)

        if problem in current_problems:
            remove_selected_problem(message.from_user.id, problem)
        else:
            add_selected_problem(message.from_user.id, problem)

        await message.answer(
            "<i>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—ã –≤–æ–ª–æ—Å (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ):</i>\n"
            "<b>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ø—Ä–æ–±–ª–µ–º—É, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å/–æ—Ç–º–µ–Ω–∏—Ç—å</b>\n\n"
            "<i>–ú–æ–∂–Ω–æ –Ω–∞–∂–∞—Ç—å '‚úÖ –ì–æ—Ç–æ–≤–æ' –±–µ–∑ –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–±–ª–µ–º</i>",
            reply_markup=keyboards.hair_problems_keyboard(get_selected_problems(message.from_user.id))
        )

@dp.message(UserState.HAIR_CHOOSING_SCALP, F.text.in_(config.SCALP_TYPES))
async def process_scalp_type(message: Message, state: FSMContext):
    scalp_type = message.text
    save_user_data(message.from_user.id, "scalp_type", scalp_type)

    await state.set_state(UserState.HAIR_CHOOSING_VOLUME)
    await message.answer(
        "<i>–•–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–º –≤–æ–ª–æ—Å–∞–º?</i>",
        reply_markup=keyboards.hair_volume_keyboard()
    )

@dp.message(UserState.HAIR_CHOOSING_VOLUME, F.text.in_(config.HAIR_VOLUME))
async def process_hair_volume(message: Message, state: FSMContext):
    hair_volume = message.text
    save_user_data(message.from_user.id, "hair_volume", hair_volume)

    hair_type = get_user_data_value(message.from_user.id, "hair_type", "")

    if hair_type == "–û–∫—Ä–∞—à–µ–Ω–Ω—ã–µ":
        await state.set_state(UserState.HAIR_CHOOSING_COLOR)
        await message.answer(
            "<i>–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç –≤–æ–ª–æ—Å:</i>",
            reply_markup=keyboards.hair_color_keyboard(hair_type)
        )
    else:
        await show_hair_results(message, state)

@dp.message(UserState.HAIR_CHOOSING_COLOR, F.text.in_(["–ë–ª–æ–Ω–¥–∏–Ω–∫–∞", "–ë—Ä—é–Ω–µ—Ç–∫–∞", "–®–∞—Ç–µ–Ω–∫–∞", "–†—É—Å–∞—è", "–†—ã–∂–∞—è"]))
async def process_hair_color(message: Message, state: FSMContext):
    hair_color = message.text
    save_user_data(message.from_user.id, "hair_color", hair_color)
    await show_hair_results(message, state)

async def show_hair_results(message: Message, state: FSMContext):
    try:
        hair_type = get_user_data_value(message.from_user.id, "hair_type", "")
        problems = get_selected_problems(message.from_user.id)
        scalp_type = get_user_data_value(message.from_user.id, "scalp_type", "")
        hair_volume = get_user_data_value(message.from_user.id, "hair_volume", "")
        hair_color = get_user_data_value(message.from_user.id, "hair_color", "")

        recommendations, photo_keys = await get_hair_recommendations_with_photos(
            hair_type, problems, scalp_type, hair_volume, hair_color
        )

        await message.answer(
            recommendations,
            reply_markup=keyboards.selection_complete_keyboard()
        )

        if photo_keys:
            await send_recommended_photos(
                message.chat.id,
                photo_keys,
                "üõçÔ∏è <b>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã:</b>"
            )
        else:
            await message.answer(
                "üì∑ –§–æ—Ç–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è —ç—Ç–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.",
                reply_markup=keyboards.selection_complete_keyboard()
            )

        await message.answer(
            config.SALES_POINTS + "\n\n" + config.DELIVERY_INFO,
            reply_markup=keyboards.selection_complete_keyboard()
        )

        await state.clear()
        clear_selected_problems(message.from_user.id)
        logger.info(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.from_user.id} –ø–æ–ª—É—á–∏–ª —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –≤–æ–ª–æ—Å")

    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ show_hair_results: {e}", exc_info=True)
        await message.answer(
            "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
            reply_markup=keyboards.selection_complete_keyboard()
        )
        await state.clear()

# ==================== –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ (–¢–û–õ–¨–ö–û –î–õ–Ø –ü–û–õ–£–ß–ï–ù–ò–Ø FILE_ID) ====================

@dp.message(AdminState.WAITING_PASSWORD)
async def process_admin_password(message: Message, state: FSMContext):
    if message.text == config.ADMIN_PASSWORD:
        await state.set_state(AdminState.ADMIN_MAIN_MENU)
        await message.answer(
            "‚úÖ <b>–î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω!</b>\n\n–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å.",
            reply_markup=keyboards.admin_main_keyboard()
        )
        logger.info(f"üîê –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.from_user.id} –≤–æ—à–µ–ª –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å")
    else:
        await message.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")

@dp.message(AdminState.ADMIN_MAIN_MENU, F.text == "üìä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ç–æ")
async def process_admin_check_photos(message: Message):
    try:
        all_photos = photo_map.get_all_photos()
        photo_count = len(all_photos)
        
        hair_count = 0
        body_count = 0
        
        for key, file_id in all_photos.items():
            if file_id:
                if key in config.PHOTO_STRUCTURE.get("–≤–æ–ª–æ—Å—ã", {}):
                    hair_count += 1
                elif key in config.PHOTO_STRUCTURE.get("—Ç–µ–ª–æ", {}):
                    body_count += 1

        stats_text = "üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ñ–æ—Ç–æ</b>\n\n"
        stats_text += f"‚Ä¢ –í—Å–µ–≥–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: {photo_count}\n"
        stats_text += f"‚Ä¢ –í–æ–ª–æ—Å—ã: {hair_count}\n"
        stats_text += f"‚Ä¢ –¢–µ–ª–æ: {body_count}\n\n"
        
        if photo_count < 5:
            stats_text += "‚ö†Ô∏è <b>–í–Ω–∏–º–∞–Ω–∏–µ:</b> –ó–∞–≥—Ä—É–∂–µ–Ω–æ –º–∞–ª–æ —Ñ–æ—Ç–æ. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã."
        
        await message.answer(
            stats_text,
            reply_markup=keyboards.admin_main_keyboard()
        )

    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ñ–æ—Ç–æ: {e}")
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ñ–æ—Ç–æ.")

@dp.message(AdminState.ADMIN_MAIN_MENU, F.text == "üì∏ –ü–æ–ª—É—á–∏—Ç—å file_id")
async def process_admin_get_file_id(message: Message, state: FSMContext):
    await state.set_state(AdminState.ADMIN_CHOOSING_SUBCATEGORY)
    await message.answer(
        "üì∏ <b>–ü–æ–ª—É—á–µ–Ω–∏–µ file_id —Ñ–æ—Ç–æ</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:",
        reply_markup=keyboards.admin_category_keyboard()
    )

@dp.message(AdminState.ADMIN_CHOOSING_SUBCATEGORY, F.text.in_(["üíá‚Äç‚ôÄÔ∏è –í–æ–ª–æ—Å—ã", "üß¥ –¢–µ–ª–æ"]))
async def process_admin_category(message: Message, state: FSMContext):
    category = "–≤–æ–ª–æ—Å—ã" if message.text == "üíá‚Äç‚ôÄÔ∏è –í–æ–ª–æ—Å—ã" else "—Ç–µ–ª–æ"
    await state.update_data(admin_category=category)
    
    await message.answer(
        f"–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è <b>{category}</b>:",
        reply_markup=keyboards.admin_subcategory_keyboard(category)
    )

@dp.message(AdminState.ADMIN_CHOOSING_SUBCATEGORY, F.text != "‚Ü©Ô∏è –ù–∞–∑–∞–¥")
async def process_admin_subcategory(message: Message, state: FSMContext):
    data = await state.get_data()
    category = data.get("admin_category")
    subcategory = message.text

    if subcategory not in config.PHOTO_STRUCTURE.get(category, {}):
        await message.answer("‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞.")
        return

    await state.update_data(admin_subcategory=subcategory)
    await state.set_state(AdminState.ADMIN_CHOOSING_PRODUCT_NAME)

    await message.answer(
        f"–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç –≤ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ <b>{subcategory}</b>:",
        reply_markup=keyboards.admin_products_keyboard(category, subcategory)
    )

@dp.message(AdminState.ADMIN_CHOOSING_SUBCATEGORY, F.text == "‚Ü©Ô∏è –ù–∞–∑–∞–¥")
async def process_admin_back_to_categories(message: Message, state: FSMContext):
    await state.set_state(AdminState.ADMIN_MAIN_MENU)
    await message.answer(
        "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∞–¥–º–∏–Ω–∫–∏:",
        reply_markup=keyboards.admin_main_keyboard()
    )

@dp.message(AdminState.ADMIN_CHOOSING_PRODUCT_NAME, F.text != "‚Ü©Ô∏è –ù–∞–∑–∞–¥")
async def process_admin_product(message: Message, state: FSMContext):
    data = await state.get_data()
    category = data.get("admin_category")
    subcategory = data.get("admin_subcategory")
    product_display_name = message.text

    product_key = None
    for key, name in config.PHOTO_STRUCTURE[category][subcategory]:
        if name == product_display_name:
            product_key = key
            break

    if not product_key:
        await message.answer("‚ùå –ü—Ä–æ–¥—É–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞.")
        return

    await state.update_data(admin_product_key=product_key)
    await state.set_state(AdminState.ADMIN_WAITING_PHOTO)
    
    current_file_id = photo_map.get_photo_file_id(product_key)
    status = "‚úÖ –£–∂–µ –µ—Å—Ç—å" if current_file_id else "‚ùå –ù–µ—Ç —Ñ–æ—Ç–æ"
    
    await message.answer(
        f"üì∏ <b>–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∞:</b>\n\n"
        f"<b>–ü—Ä–æ–¥—É–∫—Ç:</b> {product_display_name}\n"
        f"<b>–ö–ª—é—á:</b> <code>{product_key}</code>\n"
        f"<b>–°—Ç–∞—Ç—É—Å:</b> {status}\n\n"
        f"<i>–ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –µ–≥–æ file_id.</i>\n"
        f"<i>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ file_id –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ —Ñ–∞–π–ª photo_map.py</i>",
        reply_markup=ReplyKeyboardRemove()
    )

@dp.message(AdminState.ADMIN_CHOOSING_PRODUCT_NAME, F.text == "‚Ü©Ô∏è –ù–∞–∑–∞–¥")
async def process_admin_back_to_subcategories(message: Message, state: FSMContext):
    data = await state.get_data()
    category = data.get("admin_category")
    await state.set_state(AdminState.ADMIN_CHOOSING_SUBCATEGORY)
    await message.answer(
        f"–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è <b>{category}</b>:",
        reply_markup=keyboards.admin_subcategory_keyboard(category)
    )

@dp.message(AdminState.ADMIN_WAITING_PHOTO, F.photo)
async def process_admin_photo(message: Message, state: FSMContext):
    try:
        data = await state.get_data()
        product_key = data.get("admin_product_key")
        
        if not product_key:
            await message.answer("‚ùå –û—à–∏–±–∫–∞: –ø—Ä–æ–¥—É–∫—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω.")
            await state.set_state(AdminState.ADMIN_MAIN_MENU)
            await message.answer(
                "–í–æ–∑–≤—Ä–∞—Ç –≤ –∞–¥–º–∏–Ω-–º–µ–Ω—é.",
                reply_markup=keyboards.admin_main_keyboard()
            )
            return

        photo = message.photo[-1]
        file_id = photo.file_id

        # –ù–∞—Ö–æ–¥–∏–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∞
        display_name = product_key
        for category in config.PHOTO_STRUCTURE.values():
            for subcat_products in category.values():
                for key, name in subcat_products:
                    if key == product_key:
                        display_name = name
                        break

        await message.answer(
            f"‚úÖ <b>–§–æ—Ç–æ –ø–æ–ª—É—á–µ–Ω–æ!</b>\n\n"
            f"<b>–ü—Ä–æ–¥—É–∫—Ç:</b> {display_name}\n"
            f"<b>–ö–ª—é—á:</b> <code>{product_key}</code>\n\n"
            f"<b>file_id:</b>\n<code>{file_id}</code>\n\n"
            f"<i>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ file_id –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ —Ñ–∞–π–ª photo_map.py:</i>\n\n"
            f"<code>\"{product_key}\": \"{file_id}\",</code>\n\n"
            f"–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞.",
            reply_markup=keyboards.admin_main_keyboard()
        )

        await state.set_state(AdminState.ADMIN_MAIN_MENU)
        logger.info(f"üì∏ –ê–¥–º–∏–Ω –ø–æ–ª—É—á–∏–ª file_id –¥–ª—è {product_key}: {file_id[:20]}...")

    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–æ—Ç–æ –∞–¥–º–∏–Ω–∞: {e}", exc_info=True)
        await message.answer(
            f"‚ùå <b>–û—à–∏–±–∫–∞:</b>\n\n<code>{str(e)[:200]}</code>",
            reply_markup=keyboards.admin_main_keyboard()
        )
        await state.set_state(AdminState.ADMIN_MAIN_MENU)

# ==================== –ó–ê–ü–£–°–ö –ë–û–¢–ê ====================

async def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"""
    try:
        logger.info("üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ —Å–æ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º —Ñ–æ—Ç–æ...")
        
        # –£–¥–∞–ª—è–µ–º webhook –¥–ª—è —á–∏—Å—Ç–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
        await bot.delete_webhook(drop_pending_updates=True)
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–ª–ª–∏–Ω–≥
        await dp.start_polling(bot)
        
    except Exception as e:
        logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}", exc_info=True)
        raise

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        logger.info("üëã –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        logger.error(f"‚ö†Ô∏è –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ: {e}", exc_info=True)